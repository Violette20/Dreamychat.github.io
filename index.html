<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamyChat v5.0 ğŸ’</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Zcool+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-pink: #ff9a9e;
            --soft-purple: #a18cd1;
            --glass-bg: rgba(255, 255, 255, 0.92); 
            --text-color: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            height: 100vh;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-color); overflow: hidden;
        }

        .main-container {
            width: 95%; max-width: 1200px; height: 95vh;
            background: var(--glass-bg);
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            display: flex; overflow: hidden;
            border: 1px solid #fff;
        }

        /* å·¦ä¾§æ  */
        .sidebar {
            width: 320px; background: rgba(245,247,250,0.8);
            border-right: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .sidebar-header { padding: 20px; text-align: center; font-family: 'Zcool KuaiLe', cursive; font-size: 1.8rem; color: var(--soft-purple); }
        
        .char-list { flex: 1; overflow-y: auto; padding: 10px; }
        .char-item {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            border-radius: 12px; cursor: pointer; margin-bottom: 6px;
            transition: 0.2s; border: 2px solid transparent;
        }
        .char-item:hover { background: #fff; }
        .char-item.active { background: #fff; border-color: var(--primary-pink); }
        .char-avatar-sm { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ddd; }

        .btn-group { padding: 15px; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid rgba(0,0,0,0.05); }
        .btn { padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--soft-purple); color: white; }
        .btn-primary:hover { background: #8e7cc3; }
        .btn-light { background: #fff; border: 1px solid #ddd; color: #666; }

        /* ç¼–è¾‘é¢æ¿ */
        .edit-panel {
            width: 0; background: #fff; transition: width 0.3s ease;
            overflow: hidden; border-right: 1px solid #eee; display: flex; flex-direction: column;
            z-index: 10;
        }
        .edit-panel.open { width: 350px; }
        .edit-content { padding: 20px; overflow-y: auto; min-width: 350px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.85rem; color: #666; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;
            background: #f9f9f9; outline: none; font-family: inherit;
        }
        .form-group textarea { height: 100px; resize: none; }
        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 10px; display: block; object-fit: cover; border: 4px solid var(--primary-pink); }

        /* èŠå¤©åŒº */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: rgba(255,255,255,0.5); }
        .chat-header { padding: 15px 25px; background: rgba(255,255,255,0.8); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .header-avatar { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; }
        
        #chat-box { flex: 1; padding: 20px 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        
        .msg-row { display: flex; gap: 15px; max-width: 85%; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .bubble {
            padding: 14px 18px; background: #fff; border-radius: 20px;
            border-top-left-radius: 4px; line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); font-size: 0.95rem; color: #333;
        }
        .msg-row.user .bubble { background: var(--primary-pink); color: white; border-top-left-radius: 20px; border-top-right-radius: 4px; }

        .input-area { padding: 20px; background: #fff; display: flex; gap: 12px; align-items: center; border-top: 1px solid #eee; }
        #user-input { flex: 1; padding: 15px; border-radius: 30px; border: 2px solid #eee; background: #f8f8f8; outline: none; }
        #user-input:focus { border-color: var(--soft-purple); background: #fff; }
        #send-btn { width: 54px; height: 54px; border-radius: 50%; border: none; background: var(--primary-pink); color: white; font-size: 1.3rem; cursor: pointer; transition: 0.2s; }
        #send-btn:hover { transform: scale(1.1); }
        #send-btn:disabled { background: #ddd; transform: none; cursor: wait; }

        .hidden { display: none !important; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-pink); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="main-container">
    <div class="sidebar">
        <div class="sidebar-header">DreamyChat v5</div>
        <div class="char-list" id="char-list"></div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="createNewChar()"><i class="fas fa-plus"></i> æ–°å»ºè§’è‰²</button>
            <button class="btn btn-light" onclick="toggleEditPanel('settings')"><i class="fas fa-cog"></i> å…¨å±€è®¾ç½®</button>
        </div>
    </div>

    <div class="edit-panel" id="edit-panel">
        <div id="settings-form" class="edit-content hidden">
            <h3 style="margin-bottom:15px; color:var(--soft-purple);">ğŸ“¡ è®¾ç½®</h3>
            <div class="form-group">
                <label>API åœ°å€</label>
                <input type="text" id="api-url" value="https://api.openai.com/v1">
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="api-key" placeholder="sk-...">
            </div>
            <button class="btn btn-light" id="fetch-btn" onclick="fetchModels()" style="width:100%; margin-bottom:15px;">
                <span id="fetch-txt">ğŸ”— è·å–æ¨¡å‹åˆ—è¡¨</span><div id="fetch-load" class="loader hidden"></div>
            </button>
            <div class="form-group">
                <label>æ¨¡å‹</label>
                <select id="model-select"><option value="gpt-3.5-turbo">gpt-3.5-turbo</option></select>
            </div>
            <hr style="border:0; border-top:1px dashed #ccc; margin:20px 0;">
            <img src="" class="avatar-preview" id="user-avatar-preview">
            <div class="form-group"><label>æˆ‘çš„å¤´åƒ</label><input type="file" id="user-avatar-upload" accept="image/*"></div>
            <div class="form-group"><label>æˆ‘çš„æ˜µç§°</label><input type="text" id="user-name" value="æˆ‘"></div>
            <div class="form-group"><label>æˆ‘çš„è®¾å®š</label><textarea id="user-desc">æ™®é€šäººã€‚</textarea></div>
            <button class="btn btn-primary" style="width:100%" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            <button class="btn btn-light" style="width:100%; margin-top:10px; color:red;" onclick="hardReset()">âš ï¸ æ¸…ç©ºæ•°æ®</button>
        </div>

        <div id="char-form" class="edit-content hidden">
            <h3 style="margin-bottom:15px; color:var(--soft-purple);">âœï¸ ç¼–è¾‘è§’è‰²</h3>
            <img src="" class="avatar-preview" id="char-avatar-preview">
            <div class="form-group"><label>è§’è‰²å¤´åƒ</label><input type="file" id="char-avatar-upload" accept="image/*"></div>
            <div class="form-group"><label>è§’è‰²åå­—</label><input type="text" id="edit-char-name"></div>
            <div class="form-group"><label>è§’è‰²è®¾å®š (Prompt)</label><textarea id="edit-char-prompt" style="height:150px;"></textarea></div>
            <div class="form-group">
                <label>ğŸ’¬ æ°”æ³¡åˆ‡åˆ†æ¨¡å¼ (é˜²é•¿ç¯‡å¤§è®º)</label>
                <select id="edit-char-split">
                    <option value="off">å…³é—­ (å•æ°”æ³¡)</option>
                    <option value="auto">è‡ªåŠ¨åˆ‡åˆ† (æ¨èï¼åƒçœŸäººè¿å‘)</option>
                </select>
                <small style="color:#888; font-size:0.8rem;">* è‡ªåŠ¨åˆ‡åˆ†ä¼šå¼ºåˆ¶AIç”¨çŸ­å¥è¿å‘ï¼Œæ¯æ¬¡å›å¤ä¼šå¼¹å‡º 2-4 ä¸ªæ°”æ³¡ã€‚</small>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1" onclick="saveChar()">ä¿å­˜</button>
                <button class="btn btn-light" style="flex:1; color:red;" onclick="deleteChar()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <img src="" class="header-avatar" id="header-avatar">
                <div><h2 id="header-name" style="font-size:1.1rem;">Name</h2></div>
            </div>
            <div>
                <button style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:#666;" onclick="toggleEditPanel('char')"><i class="fas fa-edit"></i></button>
                <button style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:#666; margin-left:10px;" onclick="clearHistory()"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
        <div id="chat-box"></div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
            <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    // === å›¾ç‰‡å‹ç¼© (é˜²å¡é¡¿) ===
    function compressImg(file, cb) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = 150 / img.width;
                cvs.width = 150; cvs.height = img.height * scale;
                cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                cb(cvs.toDataURL('image/jpeg', 0.7));
            }
        }
    }

    // === æ•°æ®ç»“æ„ ===
    const defAvt = "https://api.dicebear.com/7.x/avataaars/svg?seed=";
    let data = {
        settings: { url: "https://api.openai.com/v1", key: "", model: "gpt-3.5-turbo", name: "æˆ‘", desc: "", avatar: defAvt+"Me" },
        chars: [{ id: 1, name: "Geminiè€å¸ˆ", avatar: defAvt+"Gem", prompt: "æ¸©æŸ”çš„AIåŠ©æ•™", splitMode: "auto", history: [] }],
        activeId: 1
    };

    // === åˆå§‹åŒ– ===
    function load() {
        const local = localStorage.getItem('dreamy_v5');
        if(local) data = JSON.parse(local);
        renderList(); loadChar();
    }
    function save() { localStorage.setItem('dreamy_v5', JSON.stringify(data)); }
    function hardReset() { if(confirm("æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")) { localStorage.removeItem('dreamy_v5'); location.reload(); } }
    load();

    // === æ¸²æŸ“é€»è¾‘ ===
    function renderList() {
        const list = document.getElementById('char-list'); list.innerHTML = '';
        data.chars.forEach(c => {
            const el = document.createElement('div');
            el.className = `char-item ${c.id === data.activeId ? 'active' : ''}`;
            el.onclick = () => { data.activeId = c.id; save(); renderList(); loadChar(); document.getElementById('edit-panel').classList.remove('open'); };
            el.innerHTML = `<img src="${c.avatar}" class="char-avatar-sm"><b>${c.name}</b>`;
            list.appendChild(el);
        });
    }

    function loadChar() {
        const c = data.chars.find(x => x.id === data.activeId);
        document.getElementById('header-name').textContent = c.name;
        document.getElementById('header-avatar').src = c.avatar;
        const box = document.getElementById('chat-box'); box.innerHTML = '';
        c.history.forEach(msg => addBubble(msg.role, msg.content, false));
        box.scrollTop = 99999;
    }

    function addBubble(role, text, animate=true) {
        const isUser = role === 'user';
        const div = document.createElement('div');
        div.className = `msg-row ${isUser ? 'user' : 'ai'}`;
        if(!animate) div.style.animation = 'none';
        
        const avatar = isUser ? data.settings.avatar : document.getElementById('header-avatar').src;
        div.innerHTML = `<img src="${avatar}" class="msg-avatar"><div class="bubble">${text.replace(/\n/g, '<br>')}</div>`;
        document.getElementById('chat-box').appendChild(div);
        document.getElementById('chat-box').scrollTop = 99999;
    }

    // === ç¼–è¾‘é¢æ¿é€»è¾‘ ===
    function toggleEditPanel(type) {
        const p = document.getElementById('edit-panel');
        const fs = document.getElementById('settings-form');
        const fc = document.getElementById('char-form');
        p.classList.add('open');
        if(type === 'settings') {
            fs.classList.remove('hidden'); fc.classList.add('hidden');
            const s = data.settings;
            document.getElementById('api-url').value = s.url;
            document.getElementById('api-key').value = s.key;
            document.getElementById('user-name').value = s.name;
            document.getElementById('user-desc').value = s.desc;
            document.getElementById('user-avatar-preview').src = s.avatar;
            const sel = document.getElementById('model-select');
            if([...sel.options].every(o=>o.value!==s.model)) sel.add(new Option(s.model, s.model));
            sel.value = s.model;
        } else {
            fs.classList.add('hidden'); fc.classList.remove('hidden');
            const c = data.chars.find(x => x.id === data.activeId);
            document.getElementById('edit-char-name').value = c.name;
            document.getElementById('edit-char-prompt').value = c.prompt;
            document.getElementById('char-avatar-preview').src = c.avatar;
            document.getElementById('edit-char-split').value = c.splitMode || "off";
        }
    }

    // ç»‘å®šä¸Šä¼ 
    ['user','char'].forEach(t => {
        document.getElementById(`${t}-avatar-upload`).onchange = function() {
            if(this.files[0]) compressImg(this.files[0], res => document.getElementById(`${t}-avatar-preview`).src = res);
        };
    });

    function saveSettings() {
        const s = data.settings;
        s.url = document.getElementById('api-url').value;
        s.key = document.getElementById('api-key').value;
        s.model = document.getElementById('model-select').value;
        s.name = document.getElementById('user-name').value;
        s.desc = document.getElementById('user-desc').value;
        s.avatar = document.getElementById('user-avatar-preview').src;
        save(); alert("å·²ä¿å­˜"); document.getElementById('edit-panel').classList.remove('open'); loadChar();
    }

    function saveChar() {
        const c = data.chars.find(x => x.id === data.activeId);
        c.name = document.getElementById('edit-char-name').value;
        c.prompt = document.getElementById('edit-char-prompt').value;
        c.avatar = document.getElementById('char-avatar-preview').src;
        c.splitMode = document.getElementById('edit-char-split').value;
        save(); alert("å·²ä¿å­˜"); document.getElementById('edit-panel').classList.remove('open'); renderList(); loadChar();
    }

    function createNewChar() {
        const id = Date.now();
        data.chars.push({ id, name:"æ–°è§’è‰²", avatar: defAvt+id, prompt:"...", splitMode:"auto", history:[] });
        data.activeId = id; save(); renderList(); toggleEditPanel('char');
    }
    function deleteChar() {
        if(data.chars.length<=1) return alert("ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªè§’è‰²");
        if(confirm("åˆ é™¤ï¼Ÿ")) {
            data.chars = data.chars.filter(x=>x.id!==data.activeId);
            data.activeId = data.chars[0].id; save(); renderList(); loadChar(); document.getElementById('edit-panel').classList.remove('open');
        }
    }
    function clearHistory() {
        if(confirm("æ¸…ç©ºèŠå¤©ï¼Ÿ")) { data.chars.find(x=>x.id===data.activeId).history=[]; save(); loadChar(); }
    }

    // === API é€šä¿¡ (æ ¸å¿ƒå‡çº§) ===
    async function fetchModels() {
        const url = document.getElementById('api-url').value.replace(/\/$/,"") + (document.getElementById('api-url').value.includes("/v1")?"":"/v1");
        const key = document.getElementById('api-key').value;
        if(!key) return alert("è¯·è¾“å…¥Key");
        document.getElementById('fetch-txt').classList.add('hidden');
        document.getElementById('fetch-load').classList.remove('hidden');
        try {
            const res = await fetch(url+"/models", {headers:{Authorization:`Bearer ${key}`}});
            const d = await res.json();
            const sel = document.getElementById('model-select'); sel.innerHTML='';
            d.data.sort((a,b)=>a.id.localeCompare(b.id)).forEach(m => sel.add(new Option(m.id, m.id)));
            alert(`æˆåŠŸåŠ è½½ ${d.data.length} ä¸ªæ¨¡å‹`);
        } catch(e) { alert("å¤±è´¥: "+e.message); }
        document.getElementById('fetch-txt').classList.remove('hidden');
        document.getElementById('fetch-load').classList.add('hidden');
    }

    const uInput = document.getElementById('user-input');
    const sBtn = document.getElementById('send-btn');
    uInput.onkeypress = e => { if(e.key==='Enter') send(); };
    sBtn.onclick = send;

    async function send() {
        const text = uInput.value.trim();
        if(!text || !data.settings.key) return;
        
        const c = data.chars.find(x => x.id === data.activeId);
        const userMsg = { role: "user", content: text };
        c.history.push(userMsg);
        addBubble("user", text);
        save();
        uInput.value = '';
        sBtn.disabled = true;

        try {
            let url = data.settings.url.replace(/\/$/, "");
            if(!url.includes("/v1")) url += "/v1";

            // --- æ ¸å¿ƒ Prompt å‡çº§ï¼šé˜²æ“æ§ + å¼ºåˆ¶åˆ†æ®µ ---
            let sysPrompt = `
            You are playing a roleplay game.
            Your character: "${c.name}". Description: ${c.prompt}.
            User character: "${data.settings.name}". Description: ${data.settings.desc}.

            [ABSOLUTE RULES]:
            1. NEVER describe the User's actions, thoughts, or dialogue. Only describe YOUR OWN (${c.name}).
            2. If the user performs an action, you must react to it, but DO NOT act for them.
            3. Reply in Chinese.
            `;

            // å¦‚æœå¼€å¯äº†è‡ªåŠ¨åˆ‡åˆ†ï¼Œæ³¨å…¥åˆ‡åˆ†æŒ‡ä»¤
            if (c.splitMode === "auto") {
                sysPrompt += `
                4. [IMPORTANT] Split your response into 2-4 short separate parts using the symbol "|||".
                Example: (Light laugh) Interesting. ||| But you know the rules. ||| (Leans closer) Are you sure?
                Each part should be a distinct bubble.
                `;
            }

            const res = await fetch(url + "/chat/completions", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${data.settings.key}` },
                body: JSON.stringify({
                    model: data.settings.model,
                    messages: [{role:"system", content:sysPrompt}, ...c.history.slice(-10)],
                    temperature: 0.8
                })
            });

            const d = await res.json();
            if(d.error) throw new Error(d.error.message);

            let reply = d.choices[0].message.content;
            
            // --- åå¤„ç†ï¼šæ£€æµ‹åˆ‡åˆ†ç¬¦å¹¶æ¨¡æ‹Ÿè¿å‘ ---
            if (reply.includes("|||")) {
                const parts = reply.split("|||").map(p => p.trim()).filter(p => p);
                for (let i = 0; i < parts.length; i++) {
                    // ä¿å­˜å®Œæ•´å†å²ï¼ˆä¸ºäº†ä¸Šä¸‹æ–‡è¿è´¯ï¼Œå­˜å®Œæ•´çš„ï¼‰
                    if(i===0) c.history.push({ role: "assistant", content: reply.replace(/\|\|\|/g, " ") });
                    
                    // è§†è§‰ä¸Šåˆ†å¼€å‘é€
                    addBubble("assistant", parts[i]);
                    // æ¨¡æ‹Ÿæ‰“å­—å»¶è¿Ÿ
                    if (i < parts.length - 1) await new Promise(r => setTimeout(r, 800 + Math.random() * 500));
                }
            } else {
                // æ²¡æœ‰è§¦å‘åˆ‡åˆ†ï¼Œæ­£å¸¸å‘é€
                c.history.push({ role: "assistant", content: reply });
                addBubble("assistant", reply);
            }
            save();

        } catch(e) {
            addBubble("assistant", "âŒ é”™è¯¯: " + e.message);
        }
        sBtn.disabled = false;
    }
</script>
</body>
</html>
